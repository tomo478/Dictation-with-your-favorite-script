<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Dictation-with-your-favorite-script</title>
  <style>
    :root {
      --bg: #0a0c10;
      --card-bg: #161b22;
      --accent: #58a6ff;
      --accent-glow: rgba(88, 166, 255, 0.3);
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --good: #3fb950;
      --bad: #f85149;
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      background: var(--bg); color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100dvh; overflow: hidden;
    }

    .app-wrap {
      max-width: 800px; margin: 0 auto;
      height: 100%; display: flex; flex-direction: column; padding: 16px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
    }

    .screen { display: none; flex-direction: column; height: 100%; }
    .screen.active { display: flex; }

    /* Home Screen */
    .usage-guide {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px; padding: 20px; margin-bottom: 24px;
      border: 1px solid rgba(88, 166, 255, 0.15);
    }
    .usage-title { font-size: 14px; font-weight: bold; color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .usage-step { font-size: 13px; margin-bottom: 8px; display: flex; gap: 10px; line-height: 1.5; }
    .step-num {
      background: var(--accent); color: #000; width: 18px; height: 18px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: bold; flex-shrink: 0; margin-top: 1px;
    }

    .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 10px; }
    @media (max-width: 480px) { .mode-grid { grid-template-columns: 1fr; } }
    
    .mode-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; cursor: pointer; transition: 0.3s; text-align: center;
    }
    .mode-card:hover { border-color: var(--accent); background: rgba(88, 166, 255, 0.05); transform: translateY(-2px); }
    .mode-card h3 { margin: 0 0 8px; color: var(--accent); font-size: 16px; }
    .mode-card p { margin: 0; font-size: 12px; color: var(--text-muted); }

    /* Setup */
    textarea {
      flex: 1; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border);
      color: var(--text); border-radius: 12px; padding: 16px; font-size: 14px;
      resize: none; outline: none; transition: 0.3s;
    }

    .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
    .toggle-item {
      background: rgba(255,255,255,0.03); padding: 10px 14px;
      border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
    }

    /* Practice */
    .progress-container { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-bottom: 15px; }
    .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }

    .display-panel {
      flex: 1; background: rgba(0, 0, 0, 0.2); border-radius: 16px;
      padding: 18px; overflow-y: auto; font-family: monospace;
      font-size: 18px; line-height: 1.8; margin-bottom: 15px; border: 1px solid var(--border);
      cursor: text; /* ã©ã“ã‚’è§¦ã£ã¦ã‚‚å…¥åŠ›ã§ãã‚‹é›°å›²æ°— */
    }
    .snippet { white-space: pre-wrap; word-break: break-all; }
    .typed { color: var(--text-muted); opacity: 0.5; }
    .cursor { background: var(--accent-glow); border-bottom: 2px solid var(--accent); font-weight: bold; }
    .mask { color: rgba(255,255,255,0.15); }

    /* Hidden input for mobile keyboard */
    #hiddenInput { position: absolute; opacity: 0; pointer-events: none; }

    .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { all: unset; cursor: pointer; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; text-align: center; transition: 0.2s; }
    .primary-btn { background: var(--accent); color: #000; width: 100%; }
    .choice-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); }
    .choice-btn.good { background: var(--good); color: #000; }
    .choice-btn.bad { background: var(--bad); }

    .reveal-btn { width: 100%; text-align: center; font-size: 11px; color: var(--text-muted); border: 1px dashed var(--border); margin-bottom: 12px; }
    .stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 12px; }
    .stat-val { font-weight: bold; color: var(--accent); margin-left: 4px; }

    .switch { width: 30px; height: 16px; background: #333; border-radius: 10px; position: relative; }
    .switch::after { content:''; position:absolute; width:12px; height:12px; top:2px; left:2px; background:#fff; border-radius:50%; transition:0.3s; }
    input:checked + .toggle-item .switch { background: var(--accent); }
    input:checked + .toggle-item .switch::after { left: 16px; }
    input[type="checkbox"] { display: none; }

    /* Animation for wrong type */
    .flash-bad { animation: flashBad 0.2s ease-in-out; }
    @keyframes flashBad {
      0% { background: transparent; }
      50% { background: rgba(248, 81, 73, 0.2); }
      100% { background: transparent; }
    }
  </style>
</head>
<body>

<div class="app-wrap">
  <div class="card" id="mainCard">
    
    <div id="screenHome" class="screen active">
      <h2 style="text-align:center; margin-bottom:24px;">English Dictation</h2>
      <div class="usage-guide">
        <div class="usage-title">ğŸš€ ä½¿ã„æ–¹</div>
        <div class="usage-step"><div class="step-num">1</div><div>ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹</div></div>
        <div class="usage-step"><div class="step-num">2</div><div>æµã‚Œã‚‹éŸ³å£°ã«åˆã‚ã›ã¦ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</div></div>
      </div>
      <div class="mode-grid">
        <div class="mode-card" onclick="selectMode('dictation')">
          <h3>ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h3>
          <p>1æ–‡å­—ãšã¤ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</p>
        </div>
        <div class="mode-card" onclick="selectMode('quiz')">
          <h3>4æŠã‚¯ã‚¤ã‚º</h3>
          <p>å˜èªã‚’é¸ã‚“ã§é€²ã‚€</p>
        </div>
      </div>
      <button id="loadBtn" style="margin-top:auto; text-align:center; opacity:0.6; font-size:12px;">å‰å›ã®ç¶šãã‹ã‚‰å†é–‹</button>
    </div>

    <div id="screenSetup" class="screen">
      <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:10px;">
        <button onclick="showScreen('home')" style="font-size:12px;">â† æˆ»ã‚‹</button>
        <span id="activeModeLabel" style="font-size:12px; color:var(--accent); font-weight:bold;"></span>
      </div>
      <textarea id="rawText" placeholder="ã“ã“ã«å°æœ¬ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
      <div class="option-grid">
        <label><input type="checkbox" id="autoSkipWS" checked><div class="toggle-item"><span>ç©ºç™½ã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—</span><div class="switch"></div></div></label>
        <label><input type="checkbox" id="normalizeQuotes" checked><div class="toggle-item"><span>è¨˜å·ã®æºã‚Œã‚’ä¿®æ­£</span><div class="switch"></div></div></label>
        <label><input type="checkbox" id="caseSensitive"><div class="toggle-item"><span>å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥</span><div class="switch"></div></div></label>
      </div>
      <button onclick="startTraining()" class="primary-btn">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</button>
    </div>

    <div id="screenPractice" class="screen">
      <input type="text" id="hiddenInput" autocomplete="off">
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <button onclick="showScreen('setup')" style="font-size:12px;">â† è¨­å®šã«æˆ»ã‚‹</button>
        <button id="resetBtn" style="font-size:12px;">æœ€åˆã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="display-panel" id="displayPanel"><div id="snippet" class="snippet"></div></div>
      
      <button id="revealBtn" class="reveal-btn">é•·æŠ¼ã—ã§æ­£è§£ã‚’è¡¨ç¤º / ã‚¿ãƒƒãƒ—ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</button>

      <div id="quizInputArea" style="display:none; margin-bottom: 10px;">
        <div id="choices" class="choices-grid"></div>
      </div>

      <div class="stats">
        <span>Correct: <span id="okCount" class="stat-val">0</span></span>
        <span>Miss: <span id="ngCount" class="stat-val" style="color:var(--bad)">0</span></span>
        <span>Accuracy: <span id="acc" class="stat-val">0%</span></span>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "script_trainer_v3";
  let state = {
    mode: 'dictation',
    text: '', tokens: [], wordIndices: [],
    idx: 0, wpos: 0, ok: 0, ng: 0, reveal: false,
    options: { autoSkipWS: true, normalizeQuotes: true, caseSensitive: false }
  };

  const el = {
    screens: { home: document.getElementById('screenHome'), setup: document.getElementById('screenSetup'), practice: document.getElementById('screenPractice') },
    rawText: document.getElementById('rawText'),
    progressBar: document.getElementById('progressBar'),
    snippet: document.getElementById('snippet'),
    hiddenInput: document.getElementById('hiddenInput'),
    displayPanel: document.getElementById('displayPanel'),
    choices: document.getElementById('choices'),
    quizArea: document.getElementById('quizInputArea'),
    okCount: document.getElementById('okCount'),
    ngCount: document.getElementById('ngCount'),
    acc: document.getElementById('acc'),
    revealBtn: document.getElementById('revealBtn'),
    activeModeLabel: document.getElementById('activeModeLabel')
  };

  window.showScreen = (name) => {
    Object.keys(el.screens).forEach(k => el.screens[k].classList.toggle('active', k === name));
    if(name === 'practice' && state.mode === 'dictation') el.hiddenInput.focus();
  };

  window.selectMode = (m) => {
    state.mode = m;
    el.activeModeLabel.textContent = m === 'dictation' ? 'ãƒ¢ãƒ¼ãƒ‰: ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³' : 'ãƒ¢ãƒ¼ãƒ‰: 4æŠã‚¯ã‚¤ã‚º';
    showScreen('setup');
  };

  function sanitize(raw) {
    return raw.replace(/\([\s\S]*?\)/g, "").replace(/\[[\s\S]*?\]/g, "")
              .replace(/^\s*[A-Za-z][A-Za-z\s'â€™\-]*:\s*/gm, "")
              .replace(/[â™ªâ™«â™©â™¬â™­â™®â™¯]/g, "").replace(/\n{3,}/g, "\n\n").trim();
  }

  function tokenize(text) {
    const tokens = [];
    const re = /([A-Za-z0-9]+(?:'[A-Za-z0-9]+)?)|(\s+)|([^\sA-Za-z0-9]+)/g;
    let m;
    while ((m = re.exec(text)) !== null) {
      if (m[1]) tokens.push({ type:"word", val:m[1], start: m.index });
      else if (m[2]) tokens.push({ type:"ws", val:m[2], start: m.index });
      else tokens.push({ type:"punc", val:m[3], start: m.index });
    }
    return tokens;
  }

  window.startTraining = () => {
    const raw = el.rawText.value.trim();
    if (!raw) return alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    state.options = {
      autoSkipWS: document.getElementById('autoSkipWS').checked,
      normalizeQuotes: document.getElementById('normalizeQuotes').checked,
      caseSensitive: document.getElementById('caseSensitive').checked
    };

    let cleaned = sanitize(raw);
    if (state.options.normalizeQuotes) {
      const map = {"â€œ":"\"","â€":"\"","â€˜":"'","â€™":"'","â€”":"-","â€“":"-","â€¦":"..."};
      cleaned = Array.from(cleaned).map(c => map[c] ?? c).join("");
    }

    state.text = cleaned;
    state.tokens = tokenize(cleaned);
    state.wordIndices = state.tokens.map((t, i) => t.type === 'word' ? i : null).filter(x => x !== null);
    state.wordPool = Array.from(new Set(state.tokens.filter(t => t.type === 'word').map(t => t.val)));
    state.idx = 0; state.wpos = 0; state.ok = 0; state.ng = 0;

    showScreen('practice');
    initModeUI();
  };

  function initModeUI() {
    el.quizArea.style.display = state.mode === 'quiz' ? 'block' : 'none';
    if (state.mode === 'dictation') { 
        skipWS(); 
        el.hiddenInput.focus();
    } else { 
        // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æœ€åˆã®å˜èªã®é–‹å§‹ä½ç½®ã«idxã‚’åˆã‚ã›ã‚‹
        if(state.wordIndices.length > 0) state.idx = state.tokens[state.wordIndices[0]].start;
        makeQuizQuestion(); 
    }
    updateUI();
  }

  function skipWS() {
    if (!state.options.autoSkipWS) return;
    while (state.idx < state.text.length && /\s/.test(state.text[state.idx])) state.idx++;
  }

  // Handle Global Typing
  window.addEventListener('keydown', (e) => {
    if (state.mode !== 'dictation' || !el.screens.practice.classList.contains('active')) return;
    if (e.key.length !== 1 && e.key !== "Enter") return;

    const typed = e.key === "Enter" ? "\n" : e.key;
    const target = state.text[state.idx];
    if(!target) return;

    const a = state.options.caseSensitive ? typed : typed.toLowerCase();
    const b = state.options.caseSensitive ? target : target.toLowerCase();

    if (a === b) {
      state.idx++; state.ok++; skipWS();
    } else {
      state.ng++;
      el.displayPanel.classList.add('flash-bad');
      setTimeout(() => el.displayPanel.classList.remove('flash-bad'), 200);
    }
    save(); updateUI();
  });

  // Mobile Focus Helper
  el.displayPanel.onclick = () => { if(state.mode === 'dictation') el.hiddenInput.focus(); };

  function makeQuizQuestion() {
    if (state.wpos >= state.wordIndices.length) return;
    const correct = state.tokens[state.wordIndices[state.wpos]].val;
    const pool = state.wordPool.filter(w => w.toLowerCase() !== correct.toLowerCase()).sort(() => 0.5 - Math.random()).slice(0, 3);
    const opts = [correct, ...pool].sort(() => 0.5 - Math.random());
    el.choices.innerHTML = "";
    opts.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = "choice-btn"; btn.textContent = opt;
      btn.onclick = () => handleQuizChoice(opt, btn);
      el.choices.appendChild(btn);
    });
  }

  function handleQuizChoice(opt, btn) {
    const tokenIdx = state.wordIndices[state.wpos];
    const correct = state.tokens[tokenIdx].val;
    const isCorrect = state.options.caseSensitive ? (opt === correct) : (opt.toLowerCase() === correct.toLowerCase());
    
    if (isCorrect) {
      state.ok++; 
      // æ¬¡ã®å˜èªã€ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆæœ«å°¾ã¾ã§idxã‚’é€²ã‚ã‚‹
      state.wpos++;
      if (state.wpos < state.wordIndices.length) {
        state.idx = state.tokens[state.wordIndices[state.wpos]].start;
      } else {
        state.idx = state.text.length;
      }
      
      btn.classList.add('good');
      setTimeout(() => { 
        state.reveal = false; 
        if (state.wpos < state.wordIndices.length) makeQuizQuestion(); 
        save(); updateUI(); 
      }, 150);
    } else {
      state.ng++; 
      btn.classList.add('bad'); 
      setTimeout(() => btn.classList.remove('bad'), 400);
      updateUI();
    }
  }

  function updateUI() {
    const total = state.mode === 'dictation' ? state.text.length : state.wordIndices.length;
    const currentProgress = state.mode === 'dictation' ? state.idx : state.wpos;
    
    el.progressBar.style.width = (currentProgress / (total || 1) * 100) + "%";

    const curCharIdx = state.idx;
    const start = Math.max(0, curCharIdx - 100);
    const end = Math.min(state.text.length, curCharIdx + 100);
    const before = state.text.slice(start, curCharIdx);
    const char = state.text[curCharIdx] ?? "";
    const after = state.text.slice(curCharIdx + 1, end);

    if (state.reveal) { 
      el.snippet.innerHTML = `<span class="typed">${before}</span><span class="cursor">${char || 'END'}</span><span>${after}</span>`; 
    } else {
      const maskedCur = char ? (/\s/.test(char) ? char : "â€¢") : "END";
      const maskedAfter = Array.from(after).map(c => /\s/.test(c) ? c : "â€¢").join("");
      el.snippet.innerHTML = `<span class="typed">${before}</span><span class="cursor">${maskedCur}</span><span class="mask">${maskedAfter}</span>`;
    }

    el.okCount.textContent = state.ok;
    el.ngCount.textContent = state.ng;
    const totalTry = state.ok + state.ng;
    el.acc.textContent = totalTry ? Math.round(state.ok / totalTry * 100) + "%" : "0%";

    const cursorEl = el.snippet.querySelector('.cursor');
    if (cursorEl) cursorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load() {
    const s = localStorage.getItem(STORAGE_KEY);
    if (!s) return false;
    state = JSON.parse(s);
    return true;
  }

  document.getElementById('resetBtn').onclick = () => {
    state.idx = 0; state.wpos = 0; state.ok = 0; state.ng = 0;
    if (state.mode === 'quiz') {
        if(state.wordIndices.length > 0) state.idx = state.tokens[state.wordIndices[0]].start;
        makeQuizQuestion();
    } else {
        skipWS();
    }
    updateUI();
  };

  document.getElementById('loadBtn').onclick = () => {
    if (load()) {
      el.rawText.value = state.text;
      el.activeModeLabel.textContent = state.mode === 'dictation' ? 'ãƒ¢ãƒ¼ãƒ‰: ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³' : 'ãƒ¢ãƒ¼ãƒ‰: 4æŠã‚¯ã‚¤ã‚º';
      showScreen('practice');
      initModeUI();
    } else alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
  };

  const setReveal = (v) => { state.reveal = v; updateUI(); };
  el.revealBtn.onmousedown = el.revealBtn.ontouchstart = (e) => { 
    if(e.type === 'touchstart') { // ã‚¿ãƒƒãƒ—ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å‡ºã™è£œåŠ©
        if(state.mode === 'dictation') el.hiddenInput.focus();
    }
    setReveal(true); 
  };
  el.revealBtn.onmouseup = el.revealBtn.ontouchend = el.revealBtn.onmouseleave = () => setReveal(false);

})();
</script>
</body>
</html>
